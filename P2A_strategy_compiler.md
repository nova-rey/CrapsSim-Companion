# Phase 2-A Analysis and Design: Strategy Compiler Layer

## 1. Current Bet-Node → Exporter Data Path
- **Bet entry nodes** (`bet-type`, `bet-prop`) normalize user selections to canonical keys via `bet_surface`, enforce required numbers for certain families, attach amounts/unit types, and append steps to `msg.recipe.steps` with optional `betId`/`note` metadata. 【F:node-red-contrib-craps/bet-type/bet-type.js†L4-L95】【F:node-red-contrib-craps/bet-prop/bet-prop.js†L6-L95】
- **Phase markers** (`comeout-marker`, `maingame-marker`, `endgame-marker`, `roll-marker`) contribute structural steps (sections/roll markers) into the same `msg.recipe.steps`, annotating gameplay phases without translating to direct engine bets. 【F:node-red-contrib-craps/comeout-marker/comeout-marker.js†L1-L27】
- **Value feeder** (`bet-in`) collects integer amounts/unit type keyed by `betId`, making them available to bet nodes through `msg.vars[betId]` when configured for feed-based values. 【F:node-red-contrib-craps/bet-in/bet-in.js†L3-L30】
- **Export path today:** `export-vanilla` consumes `msg.recipe.steps`, unrolls loops/sections, resolves canonical bet definitions, legalizes bet amounts using table scaling (`var-table`), partitions bets by phase, and emits a CrapsSim-compatible Python module. It also pulls simulation harness values from `msg.sim` (bankroll, max rolls/shooter, seed). 【F:node-red-contrib-craps/vanilla/export-vanilla.js†L52-L327】
- **Table scaling source:** `var-table` writes a `varTable` structure to flow context and forwards it on `msg.varTable`, defining min/increments and odds policy (bubble vs. standard tables). 【F:node-red-contrib-craps/vars/var-table.js†L6-L45】

## 2. Target `strategy_config` Schema (Engine-Agnostic)
A normalized object produced by the Strategy Compiler and consumed by exporters/runners.

```json
{
  "strategy_name": "three_point_molly",   // required string
  "table": {                               // optional; defaults applied if omitted
    "mode": "10",                        // matches var-table mode, e.g., "10" or "bubble"
    "min_multiple": 10,                    // table-min multiple in dollars per unit
    "odds_scheme": "3-4-5",               // descriptive string or structured limits
    "place_increments": {"4":5,"5":5,"6":6,"8":6,"9":5,"10":5},
    "lay_increment": 5,
    "prop_increment": 10,
    "flat_increment": 10,
    "odds_policy": { "enabled": true, "max_multiple": {"4":3,"5":4,"6":5,"8":5,"9":4,"10":3} },
    "bubble": false,
    "notes": "standard Strip table"
  },
  "bets": [                               // required non-empty array
    {
      "key": "pass_line",                // canonical bet_surface key (required)
      "base_amount": 10,                  // numeric, required
      "unit_type": "dollars",            // "dollars" | "units" (required)
      "number": null,                     // optional point/number when required by family
      "bet_id": "pass1",                 // optional identifier from bet nodes
      "note": "initial line bet"          // optional free-form note
    }
  ],
  "metadata": {                           // optional
    "created_by": "node-red-contrib-craps",
    "version": "x.y.z",
    "export_notes": "autogenerated from Node-RED graph",
    "authorship": { "author": "", "notes": "" }
  }
}
```

### 2.1 Required/Optional Fields
- `strategy_name`: required string sanitized for filesystem use; defaults to exporter/flow-provided fallback if missing.
- `table`: optional; when absent, exporter applies current defaults (e.g., mode "10" with 3-4-5 odds policy mirroring `var-table`).
- `bets`: required non-empty array of bet entries.
- `metadata`: optional bag for provenance/versioning.

### 2.2 Bet Entry Rules
- Required for all bets: `key`, `base_amount`, `unit_type`.
- Family-specific requirements: `number` required for families needing a point (`place`, `lay`, `hardway`, `odds` when dynamic point not set); otherwise optional/null.
- Optional passthrough: `bet_id` (for cross-node references/feeds) and `note`.
- `unit_type` aligns with existing `unitType` in nodes; acceptable values: `"units"` or `"dollars"`.
- Additional future fields (press/regress, progression metadata) can be added in later phases; omitted for Phase 2 scope.

### 2.3 Table Configuration
- Mirrors `var-table` structure so existing legality logic can reuse it: `mode`, `multiplier/min_multiple`, `bubble` flag, increment maps, `odds_policy` (enabled + per-point max multiples), and `place68Increment` if needed for derived calculations.
- `odds_scheme` provides a human-friendly summary of odds limits; exporter may compute it from `odds_policy` if not provided.

## 3. Strategy Compiler Node (Design)
- **Inputs:**
  - `msg.recipe.steps` accumulated from bet/marker nodes, including steps with `{ type, amount, unitType, number?, betId?, note? }` as produced today. 【F:node-red-contrib-craps/bet-type/bet-type.js†L85-L93】【F:node-red-contrib-craps/bet-prop/bet-prop.js†L82-L90】
  - Table context from `msg.varTable` or flow context (mirroring `var-table` node output). 【F:node-red-contrib-craps/vars/var-table.js†L6-L45】
  - Optional strategy metadata (name/notes) from message fields or node configuration.
- **Outputs:**
  - `msg.strategy_config` containing the normalized schema above; optionally also set `msg.payload = strategy_config` for convenience.
- **Aggregation rules:**
  - Flatten/unroll any loop constructs if present (similar to exporter) to ensure deterministic bet list.
  - Convert each bet-like step into a bet entry: map `type → key`, `amount → base_amount`, `unitType → unit_type`, `number` passthrough when required, `betId → bet_id`, `note → note`.
  - Preserve original ordering only for informational purposes; merging of identical bet keys should default to “keep separate entries” to avoid accidental summing unless a future option requests consolidation.
- **Conflict handling:**
  - Missing required fields (amount/unit_type/key/number when required) → emit compiler error and do not produce `strategy_config`.
  - Unknown bet keys (not found in `bet_surface`) → error.
  - Unsupported bets (`supported:false`) → keep in config with a flag (e.g., `supported:false` noted via metadata or warnings) but mark validation failure depending on strictness setting.
- **Table merge:** prefer message-level table config, then flow-level (`varTable`), else defaults matching `legalizer.getVarTable` fallback to maintain current behavior. 【F:node-red-contrib-craps/vanilla/legalizer.js†L6-L29】

## 4. Vanilla Exporter Migration (Conceptual)
- **Current flow:** `msg.recipe.steps` → unroll → canonicalize bet definitions → legalize amounts via table rules → phase-bucket aggregation → emit Python strategy + harness. 【F:node-red-contrib-craps/vanilla/export-vanilla.js†L52-L327】
- **Target flow:** bet/marker nodes → Strategy Compiler → `msg.strategy_config` → Vanilla Exporter → Python.
- **Mapping rules:**
  - For each `strategy_config.bets[]` entry: look up `bet_surface` definition to obtain `engine_code/family`; translate `key` to CrapsSim constructors (`BetPassLine`, `BetPlace`, etc.) using existing logic; use `base_amount`/`unit_type` with table scaling and legalization identical to current `dollarsFromUnitsOrLiteral` + `legalizeBetByType`. 【F:node-red-contrib-craps/vanilla/export-vanilla.js†L124-L166】【F:node-red-contrib-craps/vanilla/legalizer.js†L6-L53】
  - `number` maps to point-specific buckets for place/lay/hardway families, mirroring existing aggregation into `{place:{point:amount}, lay:{...}, hard:[{number,amount}]}`.
  - `table` section maps directly to `varTable` shape consumed by legalization; if absent, keep current defaults from `getVarTable` fallback. 【F:node-red-contrib-craps/vanilla/legalizer.js†L6-L29】
  - Metadata (strategy name, author/notes) feeds existing filename/author/notes fields without changing user-facing exporter config.
- **Compatibility:** exported Python spec remains unchanged; only the exporter input changes to read `strategy_config` instead of raw `recipe.steps`.

## 5. Validation Model
- **Compiler validation:**
  - Ensure `bets` array is non-empty and each `key` exists in `bet_surface`; reject unknown keys. 【F:node-red-contrib-craps/lib/bet_surface.js†L5-L48】
  - Enforce family-specific `number` requirements using `bet_surface` metadata/allowed numbers. 【F:node-red-contrib-craps/lib/bet_surface.js†L5-L21】
  - Validate `base_amount` is positive number and `unit_type` ∈ {`units`, `dollars`}.
  - Optionally flag bets with `supported:false` as warnings but keep them for transparency (exporter may skip).
- **Exporter validation:**
  - Confirm `strategy_config` structural integrity before conversion (presence of required sections/fields).
  - Table config: if missing/invalid, fallback to defaults (`getVarTable` behavior) with a warning; fatal error only when bet normalization cannot proceed.
  - During mapping, reject/skip bets lacking required points or with zero/negative amounts after scaling; warn on unsupported bet keys but proceed if strict mode allows (mirrors current warnings). 【F:node-red-contrib-craps/vanilla/export-vanilla.js†L112-L166】

## 6. Documentation Outline (for Phase 2-C)
1. **What is `strategy_config`?**
   - Brief definition and JSON example highlighting `strategy_name`, `table`, `bets`, `metadata`.
   - Explain it as the bridge between Node-RED graphs and exporters/API runners.
2. **Strategy Compiler Node**
   - Inputs: expects `msg.recipe.steps`, optional `msg.varTable`, optional metadata fields; compiles to `strategy_config`.
   - Outputs: sets `msg.strategy_config` (and `msg.payload` mirror), no manual editing needed in typical flows.
3. **Vanilla Exporter Internals**
   - Note that exporter now consumes `strategy_config` but user wiring stays the same.
   - Clarify that bet-key normalization still relies on `bet_surface` and that unsupported bets continue to warn.

## 7. Non-Goals Confirmed
- No code changes or behavior alterations in Phase 2-A; implementation follows in Phase 2-B.
- No API runner or HTTP changes; vanilla Python export remains the only target for now.
