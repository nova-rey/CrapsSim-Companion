<script type="text/javascript">
(function() {
  RED.nodes.registerType('clear', {
    category: 'craps-bets',
    color: '#4C8BF5',
    defaults: {
      name:  { value: "" },
      mode:  { value: "all" },       // "all" | "specific"
      types: { value: [] },           // array of bet types to clear
      points:{ value: [] }            // array of points to clear
    },
    inputs: 1,
    outputs: 1,
    icon: "icons/utility-node.svg",
    paletteLabel: "Clear Bets",
    label: function() {
      return "Clear Bets";
    },
    oneditprepare: function() {
      function setSpecificVisible(show) {
        const disp = show ? "" : "none";
        $("#clear-specific-types").css("display", disp);
        $("#clear-specific-points").css("display", disp);
      }

      // Initialize visibility
      const modeSel = $("#node-input-mode");
      setSpecificVisible(modeSel.val() === "specific");
      modeSel.on("change", function() {
        setSpecificVisible($(this).val() === "specific");
      });

      // Load multi-select defaults
      const typesSelect = $("#node-input-types");
      const selectedTypes = this.types || [];
      typesSelect.val(selectedTypes);

      const pointsSelect = $("#node-input-points");
      const selectedPoints = this.points || [];
      pointsSelect.val(selectedPoints.map(String));
    }
  });
})();
</script>

<script type="text/x-red" data-template-name="clear" data-label="Clear Bets">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="">
  </div>

  <div class="form-row">
    <label for="node-input-mode"><i class="fa fa-toggle-on"></i> Mode</label>
    <select id="node-input-mode">
      <option value="all">All bets</option>
      <option value="specific">Specific betsâ€¦</option>
    </select>
  </div>

  <div id="clear-specific-types" class="form-row" style="display:none;">
    <label for="node-input-types"><i class="fa fa-filter"></i> Types</label>
    <select id="node-input-types" multiple size="8" style="width: 70%;">
      <option value="pass">Pass</option>
      <option value="dont_pass">Don't Pass</option>
      <option value="come">Come</option>
      <option value="dont_come">Don't Come</option>
      <option value="field">Field</option>
      <option value="place">Place</option>
      <option value="lay">Lay</option>
      <option value="hardway">Hardway</option>
      <option value="prop">Prop</option>
      <option value="odds">Odds</option>
    </select>
    <div class="form-tips">Choose one or more bet types to clear.</div>
  </div>

  <div id="clear-specific-points" class="form-row" style="display:none;">
    <label for="node-input-points"><i class="fa fa-bullseye"></i> Points</label>
    <select id="node-input-points" multiple size="6" style="width: 70%;">
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
    </select>
    <div class="form-tips">
      If both <b>Types</b> and <b>Points</b> are set, a bet must match <em>both</em> to be cleared.<br/>
      If only one is set, any bet matching that filter is cleared.
    </div>
  </div>
</script>

<script type="text/x-red" data-help-name="clear">
  <h3>What this node does</h3>
  <p>Filters or removes bets carried in the Node-RED message (<code>msg.bets</code>) without issuing any CrapsSim HTTP clear call.</p>

  <h3>Inputs</h3>
  <ul>
    <li><b>Mode</b>: Clear all bets or only specific bet types/points.</li>
    <li><b>Types/Points</b>: When in <b>Specific</b> mode, choose bet families and point numbers to remove.</li>
    <li><b>Message override</b>: <code>msg.clear</code> can specify <code>{ all: true }</code> or <code>{ types: [...], points: [...] }</code>.</li>
  </ul>

  <h3>Outputs</h3>
  <p>Passes the message forward with <code>msg.bets</code> filtered according to the selection and <code>msg.cleared</code> reporting how many entries were removed.</p>

  <h3>Errors</h3>
  <ul>
    <li>Providing non-array filter values in <code>msg.clear.types</code> or <code>msg.clear.points</code>.</li>
    <li>Leaving <code>msg.bets</code> unset (nothing to clear).</li>
  </ul>
</script>
